Imports Nethereum.Hex.HexTypes
Imports Nethereum.Web3
Imports Nethereum.Hex.HexConvertors.Extensions.HexByteConvertorExtensions
Imports Nethereum.Signer.EthereumMessageSigner
Imports Nethereum.Util
Imports Nethereum.Hex.HexConvertors.Extensions
Imports System.Text.RegularExpressions


Public Class MainForm
    Private Async Sub testContract()
        Dim SHK As New Sha3Keccack

        ' from account - account we are transferring from
        Dim privateKey As New Nethereum.Signer.EthECKey(txtPrivKey.Text)
        Dim account = New Nethereum.Web3.Accounts.Account(privateKey)

        ' this can be a random account - We just need this to initialise the contract object and read the nonce
        Dim anEntirelyRandomAccount As New Nethereum.Signer.EthECKey("0000000000000000000000000000000000000000000000000000000000000001")
        Dim randomAccount = New Nethereum.Web3.Accounts.Account(anEntirelyRandomAccount)

        ' ABI and bytecode of the deployed contract
        Dim abi = "[{""constant"":true,""inputs"":[],""name"":""name"",""outputs"":[{""name"":"""",""type"":""string""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":false,""inputs"":[{""name"":""_spender"",""type"":""address""},{""name"":""_value"",""type"":""uint256""}],""name"":""approve"",""outputs"":[{""name"":""success"",""type"":""bool""}],""payable"":false,""stateMutability"":""nonpayable"",""type"":""function""},{""constant"":false,""inputs"":[{""name"":""_to"",""type"":""address""},{""name"":""_value"",""type"":""uint256""}],""name"":""distributeTokens"",""outputs"":[],""payable"":false,""stateMutability"":""nonpayable"",""type"":""function""},{""constant"":true,""inputs"":[],""name"":""totalSupply"",""outputs"":[{""name"":"""",""type"":""uint256""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":true,""inputs"":[],""name"":""isTransferable"",""outputs"":[{""name"":"""",""type"":""bool""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":false,""inputs"":[{""name"":""_from"",""type"":""address""},{""name"":""_to"",""type"":""address""},{""name"":""_value"",""type"":""uint256""}],""name"":""transferFrom"",""outputs"":[{""name"":"""",""type"":""bool""}],""payable"":false,""stateMutability"":""nonpayable"",""type"":""function""},{""constant"":true,""inputs"":[],""name"":""decimals"",""outputs"":[{""name"":"""",""type"":""uint8""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":true,""inputs"":[],""name"":""distributionAddress"",""outputs"":[{""name"":"""",""type"":""address""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":true,""inputs"":[],""name"":""signedTransferSig"",""outputs"":[{""name"":"""",""type"":""bytes4""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":true,""inputs"":[{""name"":""_owner"",""type"":""address""}],""name"":""balanceOf"",""outputs"":[{""name"":""balance"",""type"":""uint256""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":false,""inputs"":[{""name"":""tokenOwner"",""type"":""address""},{""name"":""to"",""type"":""address""},{""name"":""tokens"",""type"":""uint256""},{""name"":""fee"",""type"":""uint256""},{""name"":""nonce"",""type"":""uint256""},{""name"":""sig"",""type"":""bytes""},{""name"":""feeAccount"",""type"":""address""}],""name"":""signedTransfer"",""outputs"":[{""name"":""success"",""type"":""bool""}],""payable"":false,""stateMutability"":""nonpayable"",""type"":""function""},{""constant"":true,""inputs"":[{""name"":""from"",""type"":""address""},{""name"":""to"",""type"":""address""},{""name"":""transferAmount"",""type"":""uint256""},{""name"":""fee"",""type"":""uint256""},{""name"":""nonce"",""type"":""uint256""},{""name"":""sig"",""type"":""bytes""},{""name"":""feeAccount"",""type"":""address""}],""name"":""signedTransferCheck"",""outputs"":[{""name"":""result"",""type"":""string""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":false,""inputs"":[{""name"":""_value"",""type"":""uint256""}],""name"":""burnSent"",""outputs"":[],""payable"":false,""stateMutability"":""nonpayable"",""type"":""function""},{""constant"":true,""inputs"":[],""name"":""owner"",""outputs"":[{""name"":"""",""type"":""address""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":true,""inputs"":[{""name"":""_owner"",""type"":""address""}],""name"":""getNextNonce"",""outputs"":[{""name"":"""",""type"":""uint256""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":true,""inputs"":[],""name"":""symbol"",""outputs"":[{""name"":"""",""type"":""string""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":true,""inputs"":[{""name"":""from"",""type"":""address""},{""name"":""to"",""type"":""address""},{""name"":""transferAmount"",""type"":""uint256""},{""name"":""fee"",""type"":""uint256""},{""name"":""nonce"",""type"":""uint256""}],""name"":""signedTransferHash"",""outputs"":[{""name"":""hash"",""type"":""bytes32""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":false,""inputs"":[{""name"":""_to"",""type"":""address""},{""name"":""_value"",""type"":""uint256""}],""name"":""transfer"",""outputs"":[{""name"":"""",""type"":""bool""}],""payable"":false,""stateMutability"":""nonpayable"",""type"":""function""},{""constant"":false,""inputs"":[],""name"":""enableTransfers"",""outputs"":[],""payable"":false,""stateMutability"":""nonpayable"",""type"":""function""},{""constant"":false,""inputs"":[{""name"":""_setAddress"",""type"":""address""}],""name"":""setDistributionAddress"",""outputs"":[],""payable"":false,""stateMutability"":""nonpayable"",""type"":""function""},{""constant"":true,""inputs"":[{""name"":""hash"",""type"":""bytes32""},{""name"":""sig"",""type"":""bytes""}],""name"":""ecrecoverFromSig"",""outputs"":[{""name"":""recoveredAddress"",""type"":""address""}],""payable"":false,""stateMutability"":""pure"",""type"":""function""},{""constant"":true,""inputs"":[{""name"":""_owner"",""type"":""address""},{""name"":""_spender"",""type"":""address""}],""name"":""allowance"",""outputs"":[{""name"":""remaining"",""type"":""uint256""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":true,""inputs"":[],""name"":""signingPrefix"",""outputs"":[{""name"":"""",""type"":""bytes""}],""payable"":false,""stateMutability"":""view"",""type"":""function""},{""constant"":false,""inputs"":[{""name"":""newOwner"",""type"":""address""}],""name"":""transferOwnership"",""outputs"":[],""payable"":false,""stateMutability"":""nonpayable"",""type"":""function""},{""inputs"":[],""payable"":false,""stateMutability"":""nonpayable"",""type"":""constructor""},{""anonymous"":false,""inputs"":[{""indexed"":true,""name"":""burner"",""type"":""address""},{""indexed"":false,""name"":""value"",""type"":""uint256""}],""name"":""Burn"",""type"":""event""},{""anonymous"":false,""inputs"":[{""indexed"":true,""name"":""_from"",""type"":""address""},{""indexed"":true,""name"":""_to"",""type"":""address""},{""indexed"":false,""name"":""_value"",""type"":""uint256""}],""name"":""Transfer"",""type"":""event""},{""anonymous"":false,""inputs"":[{""indexed"":true,""name"":""_owner"",""type"":""address""},{""indexed"":true,""name"":""_spender"",""type"":""address""},{""indexed"":false,""name"":""_value"",""type"":""uint256""}],""name"":""Approval"",""type"":""event""}]"
        Dim byteCode = "0x60806040526000600860146101000a81548160ff0219169083151502179055503480156200002c57600080fd5b506040805190810160405280601981526020017f546573742044656c656761746520546f6b656e2076302e303200000000000000815250600490805190602001906200007a929190620001e5565b506012600560006101000a81548160ff021916908360ff1602179055506040805190810160405280600581526020017f5444454c5400000000000000000000000000000000000000000000000000000081525060069080519060200190620000e4929190620001e5565b50600560009054906101000a900460ff1660ff16600a0a633b9aca000260078190555033600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506007546000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055503373ffffffffffffffffffffffffffffffffffffffff1660007fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef6007546040518082815260200191505060405180910390a362000294565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200022857805160ff191683800117855562000259565b8280016001018555821562000259579182015b82811115620002585782518255916020019190600101906200023b565b5b5090506200026891906200026c565b5090565b6200029191905b808211156200028d57600081600090555060010162000273565b5090565b90565b6126cf80620002a46000396000f30060806040526004361061013e576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806306fdde0314610143578063095ea7b3146101d3578063158a49881461023857806318160ddd146102855780632121dc75146102b057806323b872dd146102df578063313ce5671461036457806337fb7e21146103955780635b1ea858146103ec57806370a08231146104555780637532eaac146104ac5780637c0fbc31146105ab578063879f30ad1461070b5780638da5cb5b1461073857806390193b7c1461078f57806395d89b41146107e657806396cfd12414610876578063a9059cbb14610913578063af35c6c714610978578063b89fc89e1461098f578063d4acaf6c146109d2578063dd62ed3e14610a89578063e2cc7a5114610b00578063f2fde38b14610b90575b600080fd5b34801561014f57600080fd5b50610158610bd3565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561019857808201518184015260208101905061017d565b50505050905090810190601f1680156101c55780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3480156101df57600080fd5b5061021e600480360381019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050610c71565b604051808215151515815260200191505060405180910390f35b34801561024457600080fd5b50610283600480360381019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050610df8565b005b34801561029157600080fd5b5061029a610ebb565b6040518082815260200191505060405180910390f35b3480156102bc57600080fd5b506102c5610f15565b604051808215151515815260200191505060405180910390f35b3480156102eb57600080fd5b5061034a600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050610f28565b604051808215151515815260200191505060405180910390f35b34801561037057600080fd5b50610379610f59565b604051808260ff1660ff16815260200191505060405180910390f35b3480156103a157600080fd5b506103aa610f6c565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3480156103f857600080fd5b50610401610f92565b60405180827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916815260200191505060405180910390f35b34801561046157600080fd5b50610496600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610fb6565b6040518082815260200191505060405180910390f35b3480156104b857600080fd5b50610591600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291908035906020019092919080359060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610ffe565b604051808215151515815260200191505060405180910390f35b3480156105b757600080fd5b50610690600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291908035906020019092919080359060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611037565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156106d05780820151818401526020810190506106b5565b50505050905090810190601f1680156106fd5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561071757600080fd5b50610736600480360381019080803590602001909291905050506114bd565b005b34801561074457600080fd5b5061074d61161d565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561079b57600080fd5b506107d0600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611643565b6040518082815260200191505060405180910390f35b3480156107f257600080fd5b506107fb61168c565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561083b578082015181840152602081019050610820565b50505050905090810190601f1680156108685780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561088257600080fd5b506108f5600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190803590602001909291908035906020019092919050505061172a565b60405180826000191660001916815260200191505060405180910390f35b34801561091f57600080fd5b5061095e600480360381019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919050505061188c565b604051808215151515815260200191505060405180910390f35b34801561098457600080fd5b5061098d6118bb565b005b34801561099b57600080fd5b506109d0600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611934565b005b3480156109de57600080fd5b50610a476004803603810190808035600019169060200190929190803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506119d4565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b348015610a9557600080fd5b50610aea600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611acc565b6040518082815260200191505060405180910390f35b348015610b0c57600080fd5b50610b15611b53565b6040518080602001828103825283818151815260200191508051906020019080838360005b83811015610b55578082015181840152602081019050610b3a565b50505050905090810190601f168015610b825780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b348015610b9c57600080fd5b50610bd1600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611b8c565b005b60048054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c695780601f10610c3e57610100808354040283529160200191610c69565b820191906000526020600020905b815481529060010190602001808311610c4c57829003601f168201915b505050505081565b600080821480610cfd57506000600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054145b1515610d0857600080fd5b81600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040518082815260200191505060405180910390a36001905092915050565b3373ffffffffffffffffffffffffffffffffffffffff16600860009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161480610ea157503373ffffffffffffffffffffffffffffffffffffffff16600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b1515610eac57600080fd5b610eb68282611c2c565b505050565b6000610f106000808073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054600754611dc390919063ffffffff16565b905090565b600860149054906101000a900460ff1681565b6000600860149054906101000a900460ff161515610f4557600080fd5b610f50848484611ddc565b90509392505050565b600560009054906101000a900460ff1681565b600860009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b7f7532eaac0000000000000000000000000000000000000000000000000000000081565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6000600860149054906101000a900460ff16151561101b57600080fd5b61102a88888888888888612196565b9050979650505050505050565b60606000611048898989898961172a565b905084600260008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020541415156110cf576040805190810160405280601581526020017f4e6f6e636520646f6573206e6f74206d617463682e000000000000000000000081525091506114b1565b600073ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff1614806111e657506111b66040805190810160405280601c81526020017f19457468657265756d205369676e6564204d6573736167653a0a333200000000815250826040518083805190602001908083835b602083101515611174578051825260208201915060208101905060208303925061114f565b6001836020036101000a0380198251168184511680821785525050505050509050018260001916600019168152602001925050506040518091039020856119d4565b73ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff1614155b1561124f57606060405190810160405280603281526020017f4d69736d6174636820696e207369676e696e67206163636f756e74206f72207081526020017f6172616d65746572206d69736d617463682e000000000000000000000000000081525091506114b1565b6000808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020548711156112f957606060405190810160405280603181526020017f5472616e7366657220616d6f756e74206578636565647320746f6b656e20626181526020017f6c616e6365206f6e20616464726573732e00000000000000000000000000000081525091506114b1565b6000808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461134b878961268590919063ffffffff16565b11156113b557606060405190810160405280602481526020017f496e73756666696369656e7420746f6b656e7320746f2070617920666f72206681526020017f6565732e0000000000000000000000000000000000000000000000000000000081525091506114b1565b6000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054866000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054011015611478576040805190810160405280600f81526020017f4f766572666c6f77206572726f722e000000000000000000000000000000000081525091506114b1565b6040805190810160405280601281526020017f416c6c20636865636b7320636c6561726564000000000000000000000000000081525091505b50979650505050505050565b600080821115156114cd57600080fd5b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054821115151561151a57600080fd5b33905061156e826000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054611dc390919063ffffffff16565b6000808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506115c582600754611dc390919063ffffffff16565b6007819055508073ffffffffffffffffffffffffffffffffffffffff167fcc16f5dbb4873280815c1ee09dbd06736cffcc184412cf7a71a0fdb75d397ca5836040518082815260200191505060405180910390a25050565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60068054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156117225780601f106116f757610100808354040283529160200191611722565b820191906000526020600020905b81548152906001019060200180831161170557829003601f168201915b505050505081565b60007f7532eaac0000000000000000000000000000000000000000000000000000000030878787878760405180887bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191681526004018773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166c010000000000000000000000000281526014018673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166c010000000000000000000000000281526014018573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166c010000000000000000000000000281526014018481526020018381526020018281526020019750505050505050506040518091039020905095945050505050565b6000600860149054906101000a900460ff1615156118a957600080fd5b6118b38383611c2c565b905092915050565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561191757600080fd5b6001600860146101000a81548160ff021916908315150217905550565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561199057600080fd5b80600860006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600080600080604185511415156119ee5760009350611ac3565b6020850151925060408501519150606085015160001a9050601b8160ff161015611a1957601b810190505b601b8160ff1614158015611a315750601c8160ff1614155b15611a3f5760009350611ac3565b600186828585604051600081526020016040526040518085600019166000191681526020018460ff1660ff1681526020018360001916600019168152602001826000191660001916815260200194505050505060206040516020810390808403906000865af1158015611ab6573d6000803e3d6000fd5b5050506020604051035193505b50505092915050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b6040805190810160405280601c81526020017f19457468657265756d205369676e6564204d6573736167653a0a33320000000081525081565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515611be857600080fd5b80600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b6000611c7f826000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054611dc390919063ffffffff16565b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550611d12826000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461268590919063ffffffff16565b6000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040518082815260200191505060405180910390a36001905092915050565b6000828211151515611dd157fe5b818303905092915050565b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614151515611e1957600080fd5b6000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020548211151515611e6657600080fd5b600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020548211151515611ef157600080fd5b611f42826000808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054611dc390919063ffffffff16565b6000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550611fd5826000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461268590919063ffffffff16565b6000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506120a682600160008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054611dc390919063ffffffff16565b600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040518082815260200191505060405180910390a3600190509392505050565b6000806121a6898989898961172a565b9050600073ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff16141580156122c057506122916040805190810160405280601c81526020017f19457468657265756d205369676e6564204d6573736167653a0a333200000000815250826040518083805190602001908083835b60208310151561224f578051825260208201915060208101905060208303925061222a565b6001836020036101000a0380198251168184511680821785525050505050509050018260001916600019168152602001925050506040518091039020856119d4565b73ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff16145b15156122cb57600080fd5b84600260008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205414151561231857600080fd5b60018501600260008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506123b0876000808c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054611dc390919063ffffffff16565b6000808b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550612443876000808b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461268590919063ffffffff16565b6000808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508773ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef896040518082815260200191505060405180910390a361253b866000808c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054611dc390919063ffffffff16565b6000808b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506125ce866000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461268590919063ffffffff16565b6000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef886040518082815260200191505060405180910390a36001915050979650505050505050565b600080828401905083811015151561269957fe5b80915050929150505600a165627a7a723058202d5378b8fb4a899a851cd2ea6bb39e3c6c7216a14bab788f1ad2ff65202581980029"
        Dim iweb3 = New Web3(randomAccount, "https://rinkeby.infura.io/")

        ' SHA3 hash of function
        Dim functionSig = RemovePrefix(Web3.Sha3("signedTransfer(address,address,uint256,uint256,uint256,bytes,address)").Substring(0, 8))

        ' contract address - Get contract
        Dim tokenContractAddress = "0xC83E130699e721F7CdEDDCb12909BEa2cEc3D621"
        Dim tokencontract = iweb3.Eth.GetContract(abi, tokenContractAddress)

        ' address where we are sending tokens to
        Dim toAccount = txtToAddress.Text
        Dim fromAccount = account.Address

        Dim tmpAmt As Int32 = Convert.ToInt32(txtAmt.Text)
        Dim tmpAmtFees As Int32 = tmpAmt * 0.01 'we take 1 % fees

        ' sending tokens
        Dim numTokens = RemovePrefix(Web3.Convert.ToWei(tmpAmt).ToString("X16"))
        Dim feeTokens = RemovePrefix(Web3.Convert.ToWei(tmpAmtFees).ToString("X16"))


        ' get nonce
        Dim getNextNounce = tokencontract.GetFunction("getNextNonce")
        Dim noncetmp = Await getNextNounce.CallAsync(Of Integer)(fromAccount)
        Dim nonce = noncetmp.ToString("X16")

        ' close iweb3, we will use this later
        iweb3 = Nothing

        ' generate offchain hash
        Dim offchainHash = SHK.CalculateHashFromHex(functionSig.ToString, tokenContractAddress.PadLeft(40, "0"), fromAccount.PadLeft(40, "0"), toAccount.PadLeft(40, "0"),
                                               numTokens.ToString.PadLeft(64, "0"), feeTokens.ToString.PadLeft(64, "0"), nonce.ToString.PadLeft(64, "0"))

        ' sign the transaction with from account private key
        Dim hash = offchainHash.HexToByteArray
        Dim obj As New Nethereum.Signer.EthereumMessageSigner
        Dim sig = obj.Sign(hash, privateKey).HexToByteArray
        'Dim test = obj.EcRecover(hash, obj.Sign(hash, privateKey.GetPrivateKey))

        ' generate onchain hash
        Dim signedTransferHash = tokencontract.GetFunction("signedTransferHash")
        Dim onchainHash = (Await signedTransferHash.CallAsync(Of Byte())(fromAccount, toAccount, numTokens, feeTokens, nonce)).ToHex

        ' initialise delegate account
        Dim delegatedprivateKey As New Nethereum.Signer.EthECKey(txtDeployPrivKey.Text)
        Dim delegatedAccount = New Nethereum.Web3.Accounts.Account(delegatedprivateKey)
        Dim delegateAddress = delegatedAccount.Address
        Dim feeAccount = delegatedAccount.Address

        ' start checks
        Dim proceed As Boolean
        Dim signedTransferCheck = tokencontract.GetFunction("signedTransferCheck")
        Dim result = Await signedTransferCheck.CallAsync(Of String)(fromAccount, toAccount, numTokens, feeTokens, nonce, sig, feeAccount)

        If result = "All checks cleared" Then
            proceed = True
        Else
            MsgBox(result)
            proceed = False
        End If

        ' compare and ensure they're the same
        If proceed Then
            Dim gas As New HexBigInteger(200000)
            Dim value As New HexBigInteger(0)

            iweb3 = New Web3(delegatedAccount, "https://rinkeby.infura.io/")
            Dim tokencontractDeployer = iweb3.Eth.GetContract(abi, tokenContractAddress)

            Dim signedTransfer = tokencontractDeployer.GetFunction("signedTransfer")
            Dim transactionHash = Await signedTransfer.SendTransactionAndWaitForReceiptAsync(delegateAddress, gas, value, , fromAccount, toAccount, numTokens, feeTokens, nonce, sig, feeAccount)

            MsgBox("Transaction included in block number: " & transactionHash.BlockNumber.Value.ToString & ", transaction hash: " & transactionHash.TransactionHash.ToString)
        End If
    End Sub

    Public Function RemovePrefix(ByVal input As String) As String
        If input.Substring(0, 2) = "0x" Then
            input = input.Substring(2)
        End If
        Return input
    End Function

    Private Sub btnExec_Click(sender As Object, e As EventArgs) Handles btnExec.Click
        Call testContract()
    End Sub

    Private Sub txtAmt_KeyPress(sender As Object, e As System.Windows.Forms.KeyPressEventArgs) Handles txtAmt.KeyPress
        If Not Char.IsNumber(e.KeyChar) AndAlso Not Char.IsControl(e.KeyChar) Then
            e.Handled = True
        End If
    End Sub
    Private Sub txtAmt_TextChanged(sender As Object, e As EventArgs) Handles txtAmt.TextChanged
        Dim digitsOnly As Regex = New Regex("[^\d]")
        txtAmt.Text = digitsOnly.Replace(txtAmt.Text, "")
    End Sub
End Class